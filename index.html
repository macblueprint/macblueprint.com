import React, { useState, useEffect } from 'react';
import {
  Apple,
  Moon,
  Sun,
  User,
  MessageCircle,
  Heart,
  Plus,
  X,
  Search
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import {
  getFirestore,
  collection,
  query,
  onSnapshot,
  addDoc,
  doc,
  updateDoc,
  arrayUnion,
  arrayRemove,
  serverTimestamp,
} from 'firebase/firestore';

// ---------- CONFIG FIREBASE ----------
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_PROYECTO.firebaseapp.com",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_PROYECTO.appspot.com",
  messagingSenderId: "TU_MESSAGING_SENDER_ID",
  appId: "TU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ---------- COMPONENTES ----------
const Header = ({ onToggleTheme, user, darkMode }) => (
  <header className="fixed top-4 left-1/2 -translate-x-1/2 w-[95%] max-w-4xl p-2 md:p-3 z-50">
    <div className={`backdrop-blur-2xl ${darkMode ? 'bg-black/30' : 'bg-white/30'} rounded-full border-white/20 border-2 shadow-lg transition-all`}>
      <nav className="flex items-center justify-between">
        <div className="flex items-center space-x-2 p-2 md:p-3">
          <Apple className="h-6 w-6 text-white" />
          <h1 className="text-white text-lg md:text-xl font-semibold whitespace-nowrap">Mac Blueprint</h1>
        </div>
        <div className="flex items-center space-x-2 p-2 md:p-3">
          <button onClick={onToggleTheme} className="p-2 text-white rounded-full hover:scale-125 hover:bg-white/10">
            {darkMode ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}
          </button>
          {user ? (
            <div className="flex items-center space-x-2 text-white bg-white/10 p-2 rounded-full">
              <User className="h-5 w-5" />
              <span className="hidden sm:inline-block text-sm">@{user.uid.slice(0, 5)}...</span>
            </div>
          ) : (
            <div className="flex items-center space-x-2 text-white bg-white/10 p-2 rounded-full">
              <User className="h-5 w-5" />
              <span className="hidden sm:inline-block text-sm">Cargando...</span>
            </div>
          )}
        </div>
      </nav>
    </div>
  </header>
);

const Post = ({ post, user, onLike }) => {
  const isLiked = post.likedBy?.includes(user?.uid) || false;
  const [likes, setLikes] = useState(post.likes || 0);
  const [localLiked, setLocalLiked] = useState(isLiked);

  useEffect(() => setLocalLiked(isLiked), [isLiked]);
  useEffect(() => setLikes(post.likes), [post.likes]);

  const handleLike = () => {
    if (!user) return;
    setLocalLiked(!localLiked);
    setLikes(localLiked ? likes - 1 : likes + 1);
    onLike(post.id, user.uid, localLiked);
  };

  return (
    <div className="bg-white dark:bg-zinc-800 p-6 rounded-3xl shadow-xl border-2 border-transparent hover:border-blue-400 dark:hover:border-blue-600 transition-all">
      <div className="flex items-center space-x-4 mb-4">
        <div className="h-10 w-10 bg-gray-200 dark:bg-zinc-700 rounded-full flex items-center justify-center font-bold">
          {post.author?.charAt(0) || 'U'}
        </div>
        <div>
          <p className="font-bold text-lg text-zinc-900 dark:text-white">{post.author}</p>
          <p className="text-sm text-gray-500 dark:text-gray-400">@{post.authorId.slice(0, 8)}...</p>
        </div>
      </div>
      <p className="text-zinc-800 dark:text-zinc-200 mb-4">{post.content}</p>
      <div className="flex items-center space-x-6 text-gray-500 dark:text-gray-400">
        <button onClick={handleLike} className={`hover:scale-125 ${localLiked ? 'text-red-500 scale-125' : ''}`}>
          <Heart size={20} fill={localLiked ? 'currentColor' : 'none'} />
        </button>
        <span>{likes}</span>
        <MessageCircle size={20} />
        <span>0</span>
      </div>
    </div>
  );
};

const PostModal = ({ onClose, user }) => {
  const [content, setContent] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!content.trim()) return;
    setLoading(true);
    await addDoc(collection(db, 'posts'), {
      author: "Usuario Anónimo",
      authorId: user.uid,
      content: content.trim(),
      createdAt: serverTimestamp(),
      likes: 0,
      likedBy: [],
    });
    setContent('');
    setLoading(false);
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
      <div className="bg-white dark:bg-zinc-900 p-8 rounded-3xl shadow-2xl w-full max-w-lg relative">
        <button onClick={onClose} className="absolute top-4 right-4"><X size={24} /></button>
        <h2 className="text-2xl font-bold mb-6 text-center">Crear Publicación</h2>
        <form onSubmit={handleSubmit} className="space-y-4">
          <textarea value={content} onChange={(e) => setContent(e.target.value)} className="w-full p-4 rounded-xl border h-40 resize-none" placeholder="¿Qué tienes en mente?..." />
          <button type="submit" disabled={loading} className="w-full bg-blue-500 text-white py-3 rounded-xl font-bold hover:bg-blue-600">
            {loading ? 'Subiendo...' : 'Publicar'}
          </button>
        </form>
      </div>
    </div>
  );
};

export default function App() {
  const [darkMode, setDarkMode] = useState(false);
  const [user, setUser] = useState(null);
  const [showPostModal, setShowPostModal] = useState(false);
  const [posts, setPosts] = useState([]);

  useEffect(() => {
    onAuthStateChanged(auth, (authUser) => {
      if (!authUser) signInAnonymously(auth);
      else setUser(authUser);
    });
  }, []);

  useEffect(() => {
    const q = query(collection(db, 'posts'));
    const unsub = onSnapshot(q, (snapshot) => {
      setPosts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });
    return () => unsub();
  }, []);

  const handleLike = async (postId, userId, hasLiked) => {
    const postRef = doc(db, 'posts', postId);
    await updateDoc(postRef, {
      likes: hasLiked ? posts.find(p => p.id === postId).likes - 1 : posts.find(p => p.id === postId).likes + 1,
      likedBy: hasLiked ? arrayRemove(userId) : arrayUnion(userId)
    });
  };

  return (
    <div className={`${darkMode ? 'dark bg-zinc-950 text-white' : 'bg-gray-50 text-zinc-900'} min-h-screen`}>
      {showPostModal && <PostModal onClose={() => setShowPostModal(false)} user={user} />}
      <Header onToggleTheme={() => setDarkMode(!darkMode)} user={user} darkMode={darkMode} />
      <main className="mt-28 px-4 max-w-4xl mx-auto pb-24">
        {user && (
          <div className="flex justify-center mb-10">
            <button onClick={() => setShowPostModal(true)} className={`${darkMode ? 'bg-white/20 text-white' : 'bg-zinc-800 text-white'} px-6 py-3 rounded-full`}>
              <Plus className="h-6 w-6" /> Crear Publicación
            </button>
          </div>
        )}
        <div className={`${darkMode ? 'bg-black/30' : 'bg-white/50'} flex items-center p-4 rounded-full mb-10`}>
          <Search className="mr-3" />
          <input type="text" placeholder="Buscar publicaciones..." className="bg-transparent flex-1 outline-none" />
        </div>
        <div className="space-y-8">
          {posts.map((post) => (
            <Post key={post.id} post={post} user={user} onLike={handleLike} />
          ))}
        </div>
      </main>
    </div>
  );
}

